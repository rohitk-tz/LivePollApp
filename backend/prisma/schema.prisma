// Prisma schema for Live Event Polling Application
// Persistence model based on specs/009-persistence-model/spec.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Session Management Module
model Session {
  id            String        @id @default(uuid())
  code          String        @unique @db.VarChar(6)
  presenterName String        @map("presenter_name") @db.VarChar(255)
  status        SessionStatus @default(PENDING)
  createdAt     DateTime      @default(now()) @map("created_at")
  startedAt     DateTime?     @map("started_at")
  endedAt       DateTime?     @map("ended_at")

  // Relations
  polls         Poll[]
  participants  Participant[]

  @@map("sessions")
  @@index([code])
}

enum SessionStatus {
  PENDING
  ACTIVE
  ENDED
}

// Poll Management Module
model Poll {
  id            String    @id @default(uuid())
  sessionId     String    @map("session_id")
  question      String    @db.Text
  pollType      PollType  @map("poll_type")
  allowMultiple Boolean   @default(false) @map("allow_multiple")
  isAnonymous   Boolean   @default(true) @map("is_anonymous")
  minRating     Int?      @map("min_rating")
  maxRating     Int?      @map("max_rating")
  sequenceOrder Int       @map("sequence_order")
  createdAt     DateTime  @default(now()) @map("created_at")
  closedAt      DateTime? @map("closed_at")

  // Relations
  session       Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  options       PollOption[]
  votes         Vote[]

  @@map("polls")
  @@index([sessionId])
  @@index([sessionId, sequenceOrder])
  @@index([closedAt])
}

enum PollType {
  MULTIPLE_CHOICE
  RATING_SCALE
  OPEN_TEXT
}

model PollOption {
  id            String @id @default(uuid())
  pollId        String @map("poll_id")
  optionText    String @map("option_text") @db.VarChar(500)
  sequenceOrder Int    @map("sequence_order")

  // Relations
  poll          Poll   @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes         Vote[]

  @@unique([pollId, sequenceOrder])
  @@map("poll_options")
  @@index([pollId])
}

// Participant Management Module
model Participant {
  id          String   @id @default(uuid())
  sessionId   String   @map("session_id")
  displayName String?  @map("display_name") @db.VarChar(100)
  joinedAt    DateTime @default(now()) @map("joined_at")

  // Relations
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  votes       Vote[]

  @@map("participants")
  @@index([sessionId])
  @@index([joinedAt])
}

// Vote Management Module
model Vote {
  id            String   @id @default(uuid())
  pollId        String   @map("poll_id")
  participantId String   @map("participant_id")
  optionId      String?  @map("option_id")
  ratingValue   Int?     @map("rating_value")
  textResponse  String?  @map("text_response") @db.Text
  submittedAt   DateTime @default(now()) @map("submitted_at")

  // Relations
  poll          Poll         @relation(fields: [pollId], references: [id], onDelete: Cascade)
  participant   Participant  @relation(fields: [participantId], references: [id], onDelete: Cascade)
  option        PollOption?  @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([participantId, pollId])
  @@map("votes")
  @@index([pollId])
  @@index([optionId])
  @@index([submittedAt])
}
